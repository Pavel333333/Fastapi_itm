stages:
  - build
  - test

# Простой тестовый job для проверки Docker
build-job:
  stage: build
  script:
    - docker info  # Проверяем, работает ли Docker
    - docker build -t app_fastapi_itm .
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

test-job:
  stage: test
  script:
    - docker compose up -d --env POSTGRES_USER=test_user --env POSTGRES_PASSWORD=test_pass --env POSTGRES_DB=test_db test_db
    - docker run -d --name fastapi_test --network=host -e DATABASE_URL=postgres://test_user:test_pass@localhost:5433/test_db -e MODE=TEST -p 8001:8000 app_fastapi_itm
    - sleep 5
    - docker exec fastapi_test pytest -s -v
    - docker stop fastapi_test
    - docker compose down
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'